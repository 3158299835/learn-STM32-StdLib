# STM32单片机串口

# 通信接口概述

通信的目的：将一个设备的数据传送到另一个设备，扩展硬件系统

通信协议：制定通信的规则，通信双方按照协议规则进行数据收发

| 名称 | 引脚 | 双工 | 时钟 | 电平 | 设备 |
| --- | --- | --- | --- | --- | --- |
| USART | TX, RX | 全双工 | 异步 | 单端 | 点对点 |
| I2C | SCL, SDA | 半双工 | 同步 | 单端 | 多设备 |
| SPI | SCLK, MOSI, MISO,CS | 全双工 | 同步 | 单端 | 多设备 |
| CAN | CAN_H, CAN_L | 半双工 | 异步 | 差分 | 多设备 |
| USB | DP, DM | 半双工 | 异步 | 差分 | 点对点 |

# **通信方式分类**

设备之间的通信方式可以分为**串行通信**和**并行通信**，

- 串行通信是按照将数据按位顺序传输，这样做的优势是占用的引脚资源少，对于引脚资源紧张的MCU来大有益处，但是由于每次只能传输一个数据，传输速度较慢。
- 并行通信就是数据的各个位同时传输，优点是数据传输快，缺点是占用引脚资源较多。

# 串行通信传输方向分类

串行通信分为**单工、半双工和全双工。**

- **单工 是**只能向着一个方向传输数据
- **半双工** 是可以双向传输，但每次只能有一个传输方向
- **全双工** 是既可以双向传输，它又可以同时有两个传输方向。

# 同步通信和异步通信

- 同步通信需要时钟线（用作时钟信号的同步）的参与，例如SPI和IIC通信接口，
- 而异步通信就是不带时钟线的，例如UART和one-wire。

**同步是：按照任务的顺序执行任务，前一个任务没有执行结束，下一个任务不会执行，要等待上一个任务执行结束。** 

> 同步可以理解为再打电话。 你没说完之前 我是不能说话的。
> 

**异步是：这两件事在同时进行**，**而不是一方等待另一方**，**因此这就是为什么一般来说异步比同步高效的本质所在。**

> 异步可以理解为发邮件。你发了邮件我就看。你不发我可以继续忙我的事情。
> 

（[单总线（one-wire](https://blog.csdn.net/weixin_46897065/article/details/136679108)）是美国 DALLAS 公司推出的外围串行扩展总线技术，与 SPI、I2C 等串行数据通信方式不同。
**它采用单根信号线，既传输时钟又传输数据，而且数据传输是双向的。**
它具有节省 I/O口线资源、结构简单、成本低廉、便于总线扩展和维护等诸多优点。）

# 串口通信

STM32提供了UART（Universal Asynchronous Receiver/Transmitter，通用异步收发器）
USART（Universal Synchronous/Asynchronous Receiver/Transmitter，通用同步异步收发器）
这两种串口通信接口。于实现与其他设备之间的数据交换。

- **UART是一种异步通信协议**，它使用起始位、数据位、校验位和停止位来定义**一个字符**的传输格式。
- **USART则是一种同步/异步通信协议**，它支持全双工通信，并具备更高的数据传输速率和更好的抗干扰能力。他也可以作为UART使用。

![image.png](STM32%E5%8D%95%E7%89%87%E6%9C%BA%E4%B8%B2%E5%8F%A3%20c47cbf7c48df453ca1cfc1b924ae2193/image.png)

# 数据帧的组成

在串口通信中，**每一个字节的数据**都装载在一个数据帧中。

> 每个数据帧由以下几个部分组成：
**起始位：**标志数据帧的开始。
**数据位：**实际传输的数据，通常为8位。
**校验位（可选）**：用于错误检测。
**停止位：**标志数据帧的结束。
> 
1. **起始位：**固定位低电平
2. **数据位长度**：可配置为8位或9位数据长度。
3. **停止位长度**：可选0.5、1、1.5或2个停止位。
4. **校验位**：可选无校验、奇校验或偶校验。
5. **停止位：**恢复高电平持续几个周期、

![image.png](STM32%E5%8D%95%E7%89%87%E6%9C%BA%E4%B8%B2%E5%8F%A3%20c47cbf7c48df453ca1cfc1b924ae2193/image%201.png)

> **起始位**
作用：标志一个数据帧的开始。
电平：固定为低电平（0）。
机制：串口的空闲状态是高电平（1），没有数据传输时，信号线处于高电平。发送数据时，起始位从高电平跳变到低电平，产生一个下降沿，通知接收设备数据传输的开始。
> 

> **数据位**
组成：数据帧的有效载荷。
长度：通常为8位，代表一个字节的8位二进制数据。
传输顺序：低位先行（在STM32中发送移位寄存器就是这样工作的）。
电平表示：1为高电平，0为低电平。
> 

> **校验位**
作用：用于数据验证，检测数据传输中的错误。
类型：奇校验和偶校验。
奇校验：确保数据帧中的1的数量是奇数。
偶校验：确保数据帧中的1的数量是偶数。
计算：根据数据位计算得来，并添加到数据位的最后。
例如，数据为00001111，有4个1（偶数）
那么偶校验之后校验位就补0，成为000011110。让整个串串的1保持偶数，否则补1
奇校验时，校验位为1，使1的数量变为奇数（000011111）。让整个串串的1保持奇数。
> 

> **停止位**
作用：标志一个数据帧的结束，同时为下一个数据帧的起始位做准备。
电平：固定为高电平（1）。
机制：在一个字节数据发送完成后，必须有一个停止位，用于数据帧间隔。如果没有停止位，当数据的最后一位是0时，下一个起始位的低电平无法形成下降沿，接收设备无法识别数据帧的开始。
> 

> **波特率**
定义：规定串口通信的速率，**即每秒传输的码元数**，**单位是波特（Baud）。**
**比特率：每秒传输的比特数，单位是比特每秒（bps）。**
**在二进制调制情况下，1个码元等于1个比特**，**所以波特率等于比特率。**
设定：发送和接收设备必须约定相同的波特率，以确保数据正确接收。
例如，波特率为1000bps，表示1秒传输1000位，每位的时间间隔为1毫秒（ms）。发送设备每隔1ms发送一位，接收设备也每隔1ms接收一位。
> 

# 采样策略等

> 起始位侦测
检测起始位：输入电路检测到一个数据帧的起始位后，会以波特率的频率连续采样一帧数据。**采样位置必须从起始位开始对齐到位的正中间**。**只要第一位对齐，后面的位也会对齐。**
16倍采样率：为了实现精确采样，**输入电路以波特率的16倍频率进行采样，**即在一位的时间内可以进行16次采样。
> 

> 采样策略
**初始采样：**在空闲状态下，采样结果一直为高电平（1）。
一旦在某个位置采集到低电平（0），说明出现了下降沿，可能是起始位。
连续采样：**在起始位期间进行16次连续采样。如果没有噪声，这16次采样结果应全为0。**
如果有噪声
噪声处理：实际电路中可能存在噪声。因此，在检测到下降沿后，额外进行几次采样：
**第3、5、7次采样。**
**第8、9、10次采样。**
噪声判断：在两批采样中，每批3次采样中至少有2个0，才能确认是起始位。如果采样结果满足条件**但有噪声，状态寄存器会设置NE（Noise Error）标志位，提醒数据有噪声**。如果3次采样中只有一个0，则认为不是起始位，电路忽略前面的数据，重新捕捉下降沿。
> 

> 中间采样
如果通过了起始位检测，接收状态从空闲变为接收状态，并且第8、9、10次采样的位置**正好是起始位的正中间**。**之后的数据位也在第8、9、10次进行采样，**确保采样位置在每个位的正中间。
> 

# STM32串口通信

在进行STM32串口通信之前，需要对串口通信参数进行配置。这些参数包括波特率、数据位、停止位、校验位等。
其中，
波特率表示每秒钟传输的bit，在STM32F103系列中，最高可达4.5Mbps；
数据位表示每个字符的数据长度(8位或者9位)，停止位用于表示字符的结束（1bit或者2bit），
校验位用于检查数据传输的正确性（无校验、奇校验或者偶校验）。

在STM32中，这些参数可以通过配置相应的寄存器来实现。